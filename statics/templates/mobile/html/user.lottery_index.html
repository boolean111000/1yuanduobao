{wc:fun:css("goods")}
{wc:fun:js("jquery.cmsapi")}
<!-- {wc:fun:js("template")} -->
<!-- {wc:fun:js("template.fun")} -->
{wc:fun:js("jquery.cartlist")}
{wc:fun:css("user.message")}
{wc:fun:css("lottery.warp")}
{wc:fun:css("lottery.skin")}
{wc:fun:css("lottery_new")}
{wc:fun:css("swiper.min")}
{wc:fun:js("swiper.min")}
{wc:fun:js("templateweb")}
{wc:fun:js("layer")}
<!-- {wc:fun:js("countUp")} -->
{wc:templates "index.header_lottery"}
<!-- 栏目导航 开始-->
<div class="clear"></div>
<style type="text/css">
    .timeBox{
        margin-top:10px;
    }

    .dianBox{
        position: relative;
        top:20px;
        left:2px;
    }

    #myTargetElement{
        letter-spacing: 0.3em;
    }
    /*.timeFormat{
        display: inline;
        line-height: 36px;
    }*/
</style>
<!--商品 wrap 开始-->
<div style="text-align: center;">
    <div class="tools left">
        <div class="yu_e">
            <div class="toggle-money show-money">
                余额 <span id="refff" class="money">{wc:$user_money}</span>元
            </div>

            <div class="toggle-money show-money">
                积分 <span id="refff" class="money">{wc:$user_points}</span>
            </div>
        </div>
        <div class="toolslist">
            <ul class="ctqc">
                <li><span class="recharge" style="position: relative; top:28px; left:-20px;"></span><a style="display:inline-block;position: relative;top:13px;left:-10px;" href="/?/member/account/userrecharge" target="_blank">充值</a></li>
            </ul>
            <ul style="float:left;">
                    <li><a href="#" id="exchange" style="margin-top:13px;">积分兑换</a></li>
                </ul>
            <ul class="twbb">
                <li><a class="touzhu" style="margin-top: 15px;" href="/?/member/lottery/lottery_record">开奖记录</a></li>
            </ul>
        </div>
    </div>
    <!-------------------------------------------->
    <div class="lottery_timer left">
        <div class="lottery_issue left">
                <p>第 <span id="current_issue">{wc:$action_no}</span> 期</p>
                <p>投注剩余时间</p>
        </div>
        <div class="timeBox">
            <div id="s1x" class="timeFormat">0</div>
            <div id="s2x" class="timeFormat">0</div>
        </div>
        <div class='dianBox'></div>
        <div class="timeBox" style="left:10px;">
            <div id="f1x" class="timeFormat">1</div>
            <div id="f2x" class="timeFormat">0</div>
        </div>
        <div class='dianBox' style="left:10px"></div>
        <div class="timeBox" style="left:20px;">
            <div id="m1x" class="timeFormat">0</div>
            <div id="m2x" class="timeFormat">0</div>
        </div>
    </div>
        <!--剩余时间结束-->
        <!--添加0-9数字 和积分规则 开始-->
    <!-- <ul class="add-number">
        <li style="width:30px;"> 0</li>
        <li id="myTargetElement"> 123456789</li>
        <li class="integration-rule">积分规则</li>
    </ul> -->
    <ul class="add-number">
        <li class="code"> 0</li>
        <li class="code"> 1</li>
        <li class="code"> 2</li>
        <li class="code"> 3</li>
        <li class="code"> 4</li>
        <li class="code"> 5</li>
        <li class="code"> 6</li>
        <li class="code"> 7</li>
        <li class="code"> 8</li>
        <li class="code"> 9</li>
        <li class="integration-rule">积分规则</li>
    </ul>
    <!--添加0-9数字 和积分规则 结束-->

 <!--    <div class="lottery_num left">
        <div class="lottery_num_box">
            <ul id="num" style="width: 250px;">
                <li style="top: 7px;"><span>正</span></li>
                <li style="top: 7px;"><span>在</span></li>
                <li style="top: 7px;"><span>开</span></li>
                <li style="top: 7px;"><span>奖</span></li>
                <li style="top: 7px;"><span>中</span></li>
            </ul>
        </div>
    </div> -->
        <!--开奖信息提示 end-->

        <div class="lottery_num left" style="left:-19px;width: 140px;border:0;">
            <p class="lottery_history_issue" style="font-size:12px;padding-top: 15px;">第 <span>{wc:$last_action_no}</span> 期</p>
            <!--<div class="lottery_num_box">
                <ul id="num" style="width: 165px;margin-left: 40px;">

                </ul>
            </div>-->
        </div>
        <div class="lottery_num left" style="width: 160px;padding-left:0;border:0;">
            <!--<p class="lottery_history_issue"><span>选择的种类</span></p>-->
            <div class="lottery_num_box">
                <ul style="width: 165px;">
                <li><span style="top: 0px;">{wc:$last_lottery_no}</span></li>
                </ul>
                <div style="padding-top: 10px;font-size: 15px; color: #8c5a8e;">
                <span style="top: 0px;" class="code-d"></span>
                <span style="top: 0px;" class="code-s"></span>
            </div>
            </div>

        </div>
        <!--上期开奖信息结束-->
    </div>
    <!--个人中心中间 结束-->
    <div class="game">
        <div class="game-main" style="margin-top:100px;">
            <div>
                <div class="pp pp11" action="tzAllSelect" length="3" random="sscRandom">
                    <div class="title" style="float:left;">买单双</div>
                    <input type="button" value="单" number=1 class="code d min" />
                    <input type="button" value="双" number=2 class="code s min" />
                </div>

                <div class="pp pp12" action="tzAllSelect" length="3" random="sscRandom">
                    <div class="title" style="float: left;">买大小</div>
                    <input type="button" value="大" number=1 class="code d min" />
                    <input type="button" value="小" number=2 class="code s min" />
                </div>

                <!--倍数开始Martin liu-->
                <div  class="pp">
                        <div class="title">倍数</div>
                        <a href="javascript:;" class="num_del num_ban" id="shopsub">-</a>
                        <input style="border: 1px solid rgb(207, 207, 207);" type="text" value="1"  class="num_dig" id="num_dig">
                        <a href="javascript:;" class="num_add" id="shopadd">+</a>
                </div>
                <!--倍数结束Martin liu-->
            </div>

             <div class="sendChoose" style="margin-top: 30px;padding-left: 80px;">
             <a href="javascript:void(0);" class="sendBtn" id="btnPostBet">立即投注</a>
             </div>


             <div class="lucky-list-head">
             中奖者最新揭晓
             </div>
             <div class="swiper-container lucky-list">
                 <div class="swiper-wrapper">

                 </div>

             </div>
             <script type="text/html" id="lucky-list">
             		<%for(var i=0;i<result.length;i++){%>
                         <div class="swiper-slide">
                             <div class="w-record-avatar">
                             <img width="40" height="40" img="<%=result[i].img%>" src="http://ceshi.ylmzshop.com/statics/uploads/photo/member.jpg">
                             </div>
                             <div class="w-record-detail">
                                 <p class="w-record-intro">
                                     获奖者:<a class="w-record-user f-txtabb" href="http://www.1yuanshangcheng.com/?/uname/<%=result[i].user_id%>" target="_blank"> <%=result[i].username%> </a>  <span class="w-record-date">于<%=result[i].buy_time%></span></p>
                                <p class="w-record-title f-txtabb">
                                <strong>
                                    <%=result[i].stage_no%>
                                 </strong>
                                 <%if(result[i].buy_content == '1'){%>
                                 使用积分
                                 <%}else{%>
                                 花费夺宝币<%=result[i].buy_money%>
                                 <%}%>
                                 购买
                                 <strong><%=result[i].buy_content%>
                                     <%if(result[i].buy_number != '-1'){%>
                                     ，<%=result[i].buy_number%>
                                     <%}%>
                                 </strong>
                                 中奖
                                 </p>
                                 <p>奖励积分:<%=result[i].award_points%></p>
                             </div>
                         </div>
             		<%}%>
             </script>




             <div class="warp lotteryHistory" style="margin-top: 20px;padding-left: 15px;">
                <div class="lotteryHistoryBody"></div>
                <div class="line">
                {wc:loop $buy_lists $v}
                    <div>单号:{wc:$v['order_sn']}</div>
                    <div>投注时间:{wc:$v['buy_time']}</div>
                    <div>期号:{wc:$v['stage_no']}</div>
                    <div>投注内容:{wc:$v['buy_content']}</div>
                    <div>金额(元):{wc:$v['buy_money']}</div>
                    <div>奖励(积分):{wc:$v['award_points']}</div>
                    <div>操作:
                        {wc:if $v['status'] == 1}
                            <a href="javascript:void(0)" orderid="{wc:$v['order_sn']}" onclick="cancelOrder($(this).attr('orderid'));">撤单</a>
                        {wc:elseif $v['status'] == 2}
                            已撤单
                        {wc:else}
                            已开奖
                        {wc:if:end}
                    </div>
                    <hr>
                {wc:loop:end}
                <div class="getMore">
                <a class="sqlist" href="/?/member/lottery/buy_record" title="查看更多投注记录">查看更多</a></div>
                </div>
        </div>
    </div>
</div>

<!--商品 wrap 结束-->
<div class="clear"></div>

<!-- <script>
    var easingFn = function (t, b, c, d) {
    var ts = (t /= d) * t;
    var tc = ts * t;
    return b + c * (tc + -3 * ts + 3 * t);
    }
    var options = {
      useEasing : true,
      easingFn: easingFn,
      useGrouping : false,
      separator : '',
      decimal : '',
    };
    var animation = new CountUp("myTargetElement", 0, 123456789, 0, 17, options);
    animation.start();
</script> -->
<script type="text/javascript">
   if (parseFloat({wc:$last_lottery_no})%2==0) {
       $('.code-d').text("双");
   }else{
       $('.code-d').text("单");
   }

    if (parseFloat({wc:$last_lottery_no})<5) {
       $('.code-s').text("小");
   }else{
       $('.code-s').text("大");
   }


    //在购买大小单双上添加点击事件
    function cancelOrder(orderid){
        if(!/\d+/.test(orderid)){
            return false;
        }

        $.ajax({
            url:'/?/member/lottery/cancel_order',
            data:{order_sn:orderid},
            dataType:"json",
            type:"post",
            success:function(data){
                if(data.errno == 0){
                    layer.alert("撤单成功", {time:2000});
                    //更新订单显示
                    $("a[orderid=" + orderid + "]").parent().html("已撤单");
                }else{
                    layer.alert("撤单失败", {time:2000});
                }
            },
            error:function(data){
                layer.alert("撤单失败", {time:2000});
            }
        });
    }

    //  倍数增减 Martin liu
    $('.num_del').click(function(){
       var num = parseFloat($('.num_dig').val());
       $('.num_dig').val(num-1?num-1:1);
    })

    $('.num_add').click(function(){
       var num = parseFloat($('.num_dig').val());
       $('.num_dig').val(num+1);
    })

    $('#num_dig').keyup(function(){
        if(parseFloat($('.num_dig').val())<=0){
            $('.num_dig').val('1');
        }
    })

    $('.integration-rule').click(function(){
        layer.open({
        title: '积分规则'
        ,content: '1.1 按数值1换1.9比例计算 每5分钟公布一次结果 全天24小时运行。<br >'+
'1.2  0到4为小 5-9为大 0 2 4 6 8为双  1 3 5 7 9为单。'
        });
    })

    $('#exchange').click(function(){
        layer.open({
        title: '积分兑换'
        ,content: '1.1 积分兑现，请联系客服：微信yysc88666  。<br >'+
'1.2  每天兑换积分的时间为早上9点到下午6点（节假日除外）。<br >'+
'1.3  积分兑换取整数兑换'
        });
    })

    $(".code").click(function(){
        $(this).siblings().filter('.checked').removeClass("checked");
        $(this).toggleClass("checked");
    });

    $("#btnPostBet").click(function(){
        var buy1 = $(".pp11 > .code").filter('.checked').val();
        var buy2 = $(".pp12 > .code").filter('.checked').val();
        //倍数
        var multiple = parseFloat($('#num_dig').val());

        if(!buy1 && !buy2){
            layer.alert("请选择购买大小或者单双!", {time:3000});
            return;
        }

        //是否使用积分代替夺宝币 0：否 1：是
        var use_points;

        var message;
        multiple_msg = multiple+"倍";

        if(!buy1){
            message = "您确认购买<span style='color:red;font-weight:800;'>" + buy2 + ","+ multiple_msg + "(花费"+2*multiple+"夺宝币)</span>吗？";
        }else if(!buy2){
            message = "您确认购买<span style='color:red;font-weight:800;'>" + buy1 + ","+ multiple_msg + "(花费"+2*multiple+"夺宝币)</span>吗？"
        }else{
            message = "您确认购买<span style='color:red;font-weight:800;'>" + buy1 + ","+buy2 + ","+ multiple_msg +"(花费"+4*multiple+"夺宝币)</span>吗？"
        }


        layer.open({
          type: 1 //Page层类型
          ,title: '你要选择哪种方式进行支付？'
          ,shade: 0.6 //遮罩透明度
          ,anim: 1 //0-6的动画形式，-1不开启
          ,content: '<div class="layui-form-item">'+
'          <div class="layui-input-block">'+
'            <input type="radio" name="coin" value="1" title="积分" id="checkin" checked ><label for="checkin">积分</label>'+
'            <input type="radio" name="coin" value="0" title="夺宝币" id="checkcoin"><label for="checkcoin">夺宝币</label>'+
'          </div>'+
'        </div>'
          ,btn: ['继续']
          ,yes: function(index, layero){
                use_points = $('.layui-input-block input:checked').val();

                if(use_points=='1'){//积分支付
                   buy_lottery(1,index);
                }else{
                    layer.close(index);
                    var index_confirm = layer.confirm(message, {
                        btn:['确认', '取消'],
                    }, function(index, layer1){
                        // var index = layer.load();
                          buy_lottery(0,index,index_confirm)
                    }, function(index, layer2){
                        /*void do nothing*/
                    });
                }


          },cancel: function(){
              return;
           }
        });


    });

    function buy_lottery(use_points,index,index_confirm){
        var num1 = $(".pp11 > .code").filter('.checked').attr("number");
        var num2 = $(".pp12 > .code").filter('.checked').attr("number");
        // 数字
        var buy_number = $('.add-number .checked').text()?$('.add-number .checked').text():-1;
        //倍数
        var multiple = parseFloat($('#num_dig').val());
        $.ajax({
            url:"/?/member/lottery/buy_lottery",
            type:"post",
            data:{buy1:num1, buy2:num2, multiple:multiple,buy_number:buy_number,use_points:use_points},
            dataType:"json",
            success:function(data){
                if(data.errno){
                    layer.close(index);
                    layer.close(index_confirm);
                    layer.alert("<strong>" + data.errmsg + "</strong>", {time:2000});
                    return false;
                }

                var html = combineHtml(data.data);
                $("#order-history").prepend(html);
                layer.close(index);
                layer.close(index_confirm);
                window.location.reload(true);

            },
            error:function(){
                layer.close(index);
                layer.close(index_confirm);
                layer.alert("<strong>购买彩票失败，请重试!</strong>", {time:2000});
            }
        });

    }


    function combineHtml(data){
        var html = "<tr>";
        html += "<td>" + data.order_sn + "</td>";
        html += "<td>" + data.buy_time + "</td>";
        html += "<td>" + data.stage_no + "</td>";
        html += "<td>" + data.buy_content + "</td>";
        html += "<td>" + data.buy_money + "</td>";
        html += "<td>" + "0积分</td>";
        html += "<td>" + "<a href='javascript:void(0);' orderid=" + data.order_sn + " onclick=\"cancelOrder($(this).attr('orderid'));\">撤单</a></td>";
        html += "</tr>";
        return html;
    }

    function gameKanJiangDataC(diffTime, actionNo){
        var thisNo=$('#current_issue').html();
        TIPS='本期['+thisNo+']已截至投注';
        console.log(diffTime);
        if(diffTime<=0){
            codeplay('正在封单中');
            $('#btnaddBet').unbind('click');
            $('#btnaddBet').bind('click', function(){
                layer.alert(TIPS);
            });
            if(S){
                layer.alert('当期销售已截止，请进入下一期购买。');
                $("#alert_close_button").val("确定");
            }
            S=false;
            KS=true;

            window.location.reload(true);
            //if(KT) clearTimeout(KT);
            //$('.lottery_history_issue span').text($('#current_issue').text());
            //setKJWaiting(kjTime);
        }else{
            if(actionNo){
               $('#current_issue').html(actionNo);
            }
            var m=Math.floor(diffTime % 60), s=(diffTime---m)/60, h=0;
            if(s<10){
                s="0"+s;
            }
            if(m<10){
                m="0"+m;
            }
            var mx=m, sx=s, hx=h;
            if(sx>60){
                hx=Math.floor(sx/60);
                sx=sx-hx*60;
                if(hx<10){
                    $('#s1x').html(0);
                    $('#s1s').html(0);
                    $('#s2x').html(hx);
                    $('#s2s').html(hx);
                }else{
                    hx=hx.toString().split('');
                    $('#s1x').html(hx[0]);
                    $('#s1s').html(hx[0]);
                    $('#s2x').html(hx[1]);
                    $('#s2s').html(hx[1]);
                }
                if(sx<10){
                    $('#f1s').html(0);
                    $('#f1x').html(0);
                    $('#f2s').html(sx);
                    $('#f2x').html(sx);
                }else{
                    sx=sx.toString().split('');
                    $('#f1s').html(sx['0']);
                    $('#f1x').html(sx['0']);
                    $('#f2s').html(sx['1']);
                    $('#f2x').html(sx['1']);
                }
                mx=mx.toString().split('');
                $('#m1s').html(mx['0']);
                $('#m1x').html(mx['0']);
                $('#m2s').html(mx['1']);
                $('#m2x').html(mx['1']);
            }else{
                $('#s1s').html(0);
                $('#s1x').html(0);
                $('#s2s').html(0);
                $('#s2x').html(0);
                sx=sx.toString().split('');
                $('#f1s').html(sx['0']);
                $('#f1x').html(sx['0']);
                $('#f2s').html(sx['1']);
                $('#f2x').html(sx['1']);
                mx=mx.toString().split('');
                $('#m1s').html(mx['0']);
                $('#m1x').html(mx['0']);
                $('#m2s').html(mx['1']);
                $('#m2x').html(mx['1']);
            }
            if(S && h==0 && ((m==30 && s==0) || (m==0 && s==4))){
                getcorrtime();
            }

            if(h==0 && m==0 && s==0){
                loadKjData();
            }else{
                if($.browser.msie){
                    T=setTimeout(function(){
                        gameKanJiangDataC(diffTime);
                    }, 1000);
                }else{
                    T=setTimeout(gameKanJiangDataC, 1000, diffTime);
                }
            }
        }
    }

    function getcorrtime(){
        window.location.reload(true);
    }

    function loadKjData(){
        $.ajax('/?/member/lottery/get_lastkj_data',{
            dataType:'json',
            cache:false,
            type:"post",
            data:{stage_no:$("#current_issue").html().trim()},
            error:function(){
                setTimeout(loadKjData, 5000);
            },
            success:function(data, textStatus, xhr){
                if(!data){
                    if(!KS) codeplay('正在开奖中');
                    setTimeout(loadKjData, 10000);//动画时间
                }else{
                    try{
                        window.location.reload(true);
                    }catch(err){
                        setTimeout(loadKjData, 5000);
                    }
                }
            }
        });
    }
    function getLuckyList(){

        $.ajax('/?/member/lottery/get_lucky_list',{
            dataType:'json',
            cache:false,
            type:"get",
            data:{},
            error:function(){
                setTimeout(getLuckyList, 5000);
            },
            success:function(data, textStatus, xhr){
               var database = {};
                   database.result = data;
               var html = template('lucky-list',database);
               $('.lucky-list .swiper-wrapper').html(html);


               var mySwiper = new Swiper ('.swiper-container', {
                    loop: true,
                    autoplay: 3000,
                    direction:'vertical',
                    // slidesPerView: 3,
                    // slidesPerColumn : 2
                })
            }
        });

    }
    getLuckyList();
    function codeplay(str){

    }

    function setKJWaiting(kjDiffTime){
        var mm=Math.floor(kjDiffTime % 60), ss=(kjDiffTime---mm)/60;
        $('#posttime').html('封单剩余时间');
        if(ss<10){
            ss="0"+ss;
        }
        if(mm<10){
            mm="0"+mm;
        }
        var mmx=mm, ssx=ss, hhx;
        if(ssx>60){
            hhx=Math.floor(ssx/60);
            ssx=ssx-hhx*60;
            if(hhx<10){$('#s1s').html(0);$('#s1x').html(0);$('#s2s').html(hhx);$('#s2x').html(hhx);}else{hhx=hhx.toString().split('');$('#s1s').html(hhx['0']);$('#s1x').html(hhx['0']);$('#s2s').html(hhx['1']);$('#s2x').html(hhx['1']);}
            if(ssx<10){$('#f1s').html(0);$('#f1x').html(0);$('#f2s').html(ssx);$('#f2x').html(ssx);}else{ssx=ssx.toString().split('');$('#f1s').html(ssx['0']);$('#f1x').html(ssx['0']);$('#f2s').html(ssx['1']);$('#f2x').html(ssx['1']);}
            mmx=mmx.toString().split('');$('#m1s').html(mmx['0']);$('#m1x').html(mmx['0']);$('#m2s').html(mmx['1']);$('#m2x').html(mmx['1']);
        }else{
            $('#s1s').html(0);$('#s1x').html(0);$('#s2s').html(0);$('#s2x').html(0);
            ssx=ssx.toString().split('');$('#f1s').html(ssx['0']);$('#f1x').html(ssx['0']);$('#f2s').html(ssx['1']);$('#f2x').html(ssx['1']);
            mmx=mmx.toString().split('');$('#m1s').html(mmx['0']);$('#m1x').html(mmx['0']);$('#m2s').html(mmx['1']);$('#m2x').html(mmx['1']);
        }
        if(Math.floor(mm)==0 && Math.floor(ss)==0){
            KS=false;
            getQiHao();
        }else{
            if($.browser.msie){
                KT=setTimeout(function(){
                    setKJWaiting(kjDiffTime);
                }, 1000);
            }else{
                KT=setTimeout(setKJWaiting, 1000, kjDiffTime);
            }
        }
    }

    $(function(){
        window.S={wc:$diffTime};
        gameKanJiangDataC(window.S);
    });
</script>
{wc:templates "index.footer"}
